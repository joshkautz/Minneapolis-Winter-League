rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user's email is verified
    function isEmailVerified() {
      return request.auth != null && request.auth.token.email_verified == true;
    }
    //////////////////////////////////////////////////////////////////////////////
    // STRIPE INTEGRATION - Secure payment data access
    //////////////////////////////////////////////////////////////////////////////
    
    // CUSTOMERS: Users can only access their own payment data
    match /customers/{uid} {
      allow read: if isAuthenticated() && request.auth.uid == uid;
      
      // Checkout sessions: User-specific
      match /checkout_sessions/{id} {
        allow read, write: if isAuthenticated() && request.auth.uid == uid;
      }
      
      // Subscriptions: Read-only for users
      match /subscriptions/{id} {
        allow read: if isAuthenticated() && request.auth.uid == uid;
      }
      
      // Payments: Read-only for users  
      match /payments/{id} {
        allow read: if isAuthenticated() && request.auth.uid == uid;
      }
    }
    
    // STRIPE: New custom Stripe integration (replaces customers collection)
    match /stripe/{uid} {
      allow read: if isAuthenticated() && request.auth.uid == uid;

      // Checkout sessions: User can read and write their own
      match /checkouts/{id} {
        allow read, write: if isAuthenticated() && request.auth.uid == uid;
      }

      // Payments: Read-only for users (created by webhook)
      match /payments/{id} {
        allow read: if isAuthenticated() && request.auth.uid == uid;
      }
    }

    // Synced Stripe products/prices: Public read for pricing display
    match /stripe/products/items/{id} {
      allow read: if true;
    }

    match /stripe/prices/items/{id} {
      allow read: if true;
    }

    // PRODUCTS: Public read access for pricing display (legacy - Firebase Stripe Extension)
    match /products/{id} {
      allow read: if true;

      match /prices/{id} {
        allow read: if true;
      }

      match /tax_rates/{id} {
        allow read: if true;
      }
    }

    match /seasons/{seasonId} {
      allow read: if true;
      allow create: if false; // Force use of Functions
      allow update: if false; // Force use of Functions
      allow delete: if false; // Force use of Functions
    }
    
    match /games/{gameId} {
      allow read: if true;
      allow create: if false; // Force use of Functions
      allow update: if false; // Force use of Functions
      allow delete: if false; // Force use of Functions
    }
    
    match /teams/{teamId} {
      allow read: if true;
      allow create: if false; // Use createTeamViaFunction
      allow update: if false; // Use editTeamViaFunction, manageTeamPlayerViaFunction
      allow delete: if false; // Use deleteTeamViaFunction
    }
    
    match /players/{playerId} {
      allow read: if true;
      allow create: if false; // Use createPlayerViaFunction
      allow update: if false; // Use updatePlayerViaFunction  
      allow delete: if false; // Use deletePlayerViaFunction
    }
    
    match /offers/{offerId} {
      allow read: if true;
      allow create: if false; // Use createOfferViaFunction
      allow update: if false; // Use updateOfferStatusViaFunction 
      allow delete: if false; // Manual process
    }

    match /waivers/{waiverId} {
      allow read: if true;
      allow create: if false; // Use onPaymentCreated
      allow update: if false; // Use dropboxSignWebhook 
      allow delete: if false; // Manual process
    }

    match /news/{newsId} {
      allow read: if true; // Public read access for all users
      allow create: if false; // Use createNewsViaFunction (future)
      allow update: if false; // Use updateNewsViaFunction (future)
      allow delete: if false; // Use deleteNewsViaFunction (future)
    }

    match /rankings/{playerId} {
      allow read: if true;
      allow create: if false; // Functions only
      allow update: if false; // Functions only
      allow delete: if false; // Functions only
    }
    
    match /rankings-history/{snapshotId} {
      allow read: if true;
      allow create: if false; // Functions only
      allow update: if false; // Functions only
      allow delete: if false; // Functions only
    }
    
    match /rankings-calculations/{calculationId} {
      allow read: if true;
      allow create: if false; // Functions only
      allow update: if false; // Functions only
      allow delete: if false; // Functions only
    }

    match /badges/{badgeId} {
      allow read: if true;
      allow create: if false; // Use createBadgeViaFunction
      allow update: if false; // Use updateBadgeViaFunction
      allow delete: if false; // Use deleteBadgeViaFunction
    }

    match /teams/{teamId}/badges/{badgeId} {
      allow read: if true;
      allow create: if false; // Use awardBadgeViaFunction
      allow update: if false; // Badges are immutable once awarded
      allow delete: if false; // Use revokeBadgeViaFunction
    }

    match /siteSettings/{settingId} {
      allow read: if true; // Public read for theme settings
      allow create: if false; // Use updateSiteSettingsViaFunction
      allow update: if false; // Use updateSiteSettingsViaFunction
      allow delete: if false; // Manual process only
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}